<!doctype html>
<html class="no-js" lang="">
<head>
  <meta charset="utf-8">
  <meta name="description" content="Velocicast sso proof of concept">
  <title>Velocicast SSO - login</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/css/materialize.min.css">
  <link rel="stylesheet" href="css/main.css">

</head>
<body>
    <section class="user-login">
        <h1>User Login</h1>
        <form id="loginForm">
            <input type="text" id="username" placeholder="Username" pattern=".*" required>
            <input type="password" id="password" placeholder="Password" pattern=".*" required>
            <input class="login-btn btn" type="submit" value="login">
        </form>
    </section>
    <script src="js/vendor/aws-cognito-sdk.min.js"></script>
    <script src="js/vendor/amazon-cognito-identity.min.js"></script>
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.10/lodash.min.js"></script>-->
    <script type=module src="js/main.js"></script>
    <script>
        window.addEventListener("load", function(event) {
            /*global Larry*/
            let loginFormElem = document.querySelector("#loginForm");
            let usernameElem = loginFormElem.querySelector('#username');
            let passElem = loginFormElem.querySelector('#password');
            
            /**************************************************************************************/
            /*START RENDER METHODS */
            /**************************************************************************************/
            
            /**************************************************************************************/
            /*END RENDER METHODS */
            /*START HANDLER METHODS */
            /**************************************************************************************/
            function displayMessage(title,contents){
                document.body.innerHTML=`
                    <h1>${title}<h1>
                `;
                let contentsElem = document.createElement('div');
                contentsElem.innerHTML = contents;
                document.body.appendChild(contentsElem);
            }
            function syncLoginBtnActionableState(){
                let loginBtnElem = loginFormElem.querySelector('.login-btn');
                if(passElem.value && usernameElem.value){
                    loginBtnElem.disabled = false;
                }
                else{
                    loginBtnElem.disabled = true;
                }
            };
            /**************************************************************************************/
            /*END HANDLER METHODS */
            /*START EVENT LISTENERS */
            /**************************************************************************************/
            //setup listeners for enabling/disabling registration button
            syncLoginBtnActionableState();
            usernameElem.addEventListener("change",syncLoginBtnActionableState);
            passElem.addEventListener("change",syncLoginBtnActionableState);
            
            //setup listener for form submission
            loginFormElem.addEventListener("submit",(event)=>{
                event.preventDefault();
                let userName = usernameElem.value;
                let password = passElem.value;
                
            
                //submit the registration to cognito
                let userPool = new Larry._classes.CognitoUserPool(null,Larry._config.cognito);
                userPool.signin(userName, password)
                    .then((result)=>{
                        Larry._globalState._authenticatedUser = userPool.getCurrentUser();
                        Larry._globalState._userPool = userPool;
                        console.info("Login Successfully Completed!!!!",Larry._globalState._authenticatedUser);
                        userPool.retrieveAuthToken()
                            .then((jwt)=>{
                                displayMessage("Login Successful",`
                                <p>Kick back and celebrate you earned it!!!!</p>
                                <p>Here is your JWT: <pre>${jwt}</pre></p>
                                `);        
                            })
                        
                    })
                    .catch((e)=>{
                        console.error("Login Failed!!!!",e);
                        displayMessage("Login Failed",`<p>Did you type things in correctly???</p><p>Here is the error info:</p><pre>${JSON.stringify(e,null,'\t')}</pre>`);
                    });
            });
            /**************************************************************************************/
            /*END EVENT LISTENERS */
            /**************************************************************************************/
        });
    </script>
</body>
</html>